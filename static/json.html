<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Viewer & Comparator - SwimFlow</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .json-container { width: 100vw; min-height: 100vh; padding: 24px; display: flex; flex-direction: column; gap: 24px; }
    .panels-container { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; align-items: start; }
    .left-panel, .right-panel { display: flex; flex-direction: column; gap: 20px; }

    .json-input-section {
      background: white; border-radius: 16px; padding: 24px;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 4px 6px rgba(0,0,0,.07), 0 1px 3px rgba(0,0,0,.06);
      transition: box-shadow .3s ease;
    }
    .json-input-section:hover { box-shadow: 0 10px 15px rgba(0,0,0,.1), 0 4px 6px rgba(0,0,0,.05); }

    .json-input-group { margin-bottom: 20px; position: relative; }
    .json-input-group:not(:first-child) { border-top: 1px solid rgba(0,0,0,.06); padding-top: 20px; }

    .json-textarea {
      width: 100%; min-height: 200px; padding: 14px 16px;
      border: 2px solid #e2e8f0; border-radius: 12px;
      font-family: 'Monaco','Menlo','Ubuntu Mono',monospace;
      font-size: 13px; resize: vertical; transition: all .3s ease;
      background: #f8fafc; color: #1a202c;
    }
    .json-textarea:focus { outline: none; border-color: #3b82f6; background: #fff; box-shadow: 0 0 0 3px rgba(59,130,246,.1); }
    .json-textarea.error { border-color: #ef4444; background: #fef2f2; }
    .json-textarea.error:focus { box-shadow: 0 0 0 3px rgba(239,68,68,.1); }

    .json-actions { display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }

    .btn {
      padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer;
      font-weight: 500; transition: all .3s ease;
      display: inline-flex; align-items: center; gap: 6px; font-size: 13px;
      box-shadow: 0 2px 4px rgba(0,0,0,.08);
    }
    .btn:active { transform: scale(.98); }
    .btn-primary { background: linear-gradient(135deg,#3b82f6 0%,#2563eb 100%); color:#fff; }
    .btn-primary:hover { background: linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%); box-shadow: 0 4px 12px rgba(59,130,246,.3); transform: translateY(-2px); }
    .btn-secondary { background: linear-gradient(135deg,#64748b 0%,#475569 100%); color:#fff; }
    .btn-secondary:hover { background: linear-gradient(135deg,#475569 0%,#334155 100%); box-shadow: 0 4px 12px rgba(100,116,139,.3); transform: translateY(-2px); }
    .btn-success { background: linear-gradient(135deg,#10b981 0%,#059669 100%); color:#fff; }
    .btn-success:hover { background: linear-gradient(135deg,#059669 0%,#047857 100%); box-shadow: 0 4px 12px rgba(16,185,129,.3); transform: translateY(-2px); }

    /* Cleaner, code-like preview (no borders/shadows) */
    .json-preview { border: none !important; box-shadow: none !important; background: transparent !important; margin-top: 15px; border-radius: 12px; }
    .json-preview-header { background: transparent !important; border-bottom: none !important; padding: 0 0 8px 0 !important; }
    .json-preview-title { font-weight: 600; color: #1a202c; font-size: 13px; }
    .json-preview-actions { display:flex; gap:8px; }

    .mini-btn {
      padding: 6px 10px; font-size: 12px;
      border: 1px solid #e2e8f0; background: white; border-radius: 8px;
      cursor: pointer; transition: all .2s ease; color: #475569; font-weight: 500;
    }
    .mini-btn:hover { background:#f8fafc; border-color:#cbd5e1; color:#1a202c; }

    .json-viewer {
      padding: 12px 0; font-family: 'Monaco','Menlo','Ubuntu Mono',monospace;
      font-size: 12px; line-height: 1.6; background: transparent !important; overflow: visible;
    }

    .json-item { margin: 3px 0; position: relative; }
    .json-key { color: #dc2626; font-weight: 600; }
    .json-string { color: #0369a1; }
    .json-number { color: #7c3aed; }
    .json-boolean { color: #ea580c; }
    .json-null { color: #6366f1; }

    /* Comparison section visuals */
    .comparison-section {
      padding: 24px; background: white; border-radius: 16px; width:100%;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 4px 6px rgba(0,0,0,.07), 0 1px 3px rgba(0,0,0,.06);
    }
    .comparison-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid #f1f5f9; }
    .comparison-grid { display:flex; flex-direction:column; gap:20px; }
    .comparison-item { background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; overflow:hidden; }
    .comparison-item-header { background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%); padding:14px 16px; font-weight:600; }
    .comparison-content { padding:16px; font-family:'Monaco','Menlo','Ubuntu Mono',monospace; font-size:12px; line-height:1.6; background:#fff; }

    .summary-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .summary-table th {
      background: linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%);
      padding: 12px; text-align: left; font-weight: 600; border-bottom: 2px solid #e2e8f0; font-size: 13px;
      position: sticky; top: 0; z-index: 1;
    }
    .summary-table td { padding: 10px 12px; border-bottom: 1px solid #e2e8f0; font-size: 12px; max-width: 300px; word-wrap: break-word; }

    .diff-added{background:#dcfce7;color:#166534;padding:3px 6px;border-radius:4px;font-weight:500;}
    .diff-removed{background:#fee2e2;color:#991b1b;padding:3px 6px;border-radius:4px;font-weight:500;}
    .diff-changed{background:#cffafe;color:#164e63;padding:3px 6px;border-radius:4px;font-weight:500;}
    .diff-key-missing{background:#fee2e2;color:#991b1b;padding:3px 6px;border-radius:4px;font-weight:500;}

    /* THIS is the light-green highlight for changed values */
    .diff-value-changed{
      background:#dcfce7; color:#166534;
      padding:2px 6px; border-radius:4px;
      font-family:'Monaco','Menlo','Ubuntu Mono',monospace;
    }

    .diff-value-old{background:#fee2e2;color:#991b1b;padding:2px 6px;border-radius:4px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;}
    .diff-value-new,.diff-value-added{background:#dcfce7;color:#166534;padding:2px 6px;border-radius:4px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;}
    .diff-value-removed{background:#fee2e2;color:#991b1b;padding:2px 6px;border-radius:4px;font-family:'Monaco','Menlo','Ubuntu Mono',monospace;}

    /* Code-like structure rules */
    .json-children { border-left: none !important; padding-left: 0 !important; margin-left: 20px !important; }
    .json-wrapper { display: block; font-family:'Monaco','Menlo','Ubuntu Mono',monospace; }
    .json-openline, .json-closeline { display: flex; align-items: baseline; gap: 6px; line-height: 1.6; }
    .json-brace { color: #111827; user-select: none; }
    .json-comma { color: #111827; }
    .json-toggle { cursor: pointer; user-select: none; color:#64748b; transition: color .2s ease; font-size:12px; line-height:1; margin-right:2px; }
    .json-toggle:hover { color:#3b82f6; }

    .json-inline-collapsed { display: none; white-space: nowrap; color:#94a3b8; font-style: italic; }
    .json-inline-comma { display: none; color:#111827; }
    .json-closer { color:#111827; } /* visible closing brace/bracket when expanded */

    .remove-json-btn {
      position:absolute; top:10px; right:10px; width:28px; height:28px;
      background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
      color:#fff; border:none; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;
      font-size:16px; transition: all .3s ease; box-shadow: 0 2px 4px rgba(239,68,68,.2);
    }
    .remove-json-btn:hover { background: linear-gradient(135deg,#dc2626 0%,#b91c1c 100%); transform: scale(1.1); }
    .json-input-group:only-child .remove-json-btn { display:none; }

    ::-webkit-scrollbar { width:8px; height:8px; }
    ::-webkit-scrollbar-track { background:#f1f5f9; border-radius:10px; }
    ::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }
    ::-webkit-scrollbar-thumb:hover { background:#94a3b8; }
  </style>
</head>
<body>
  <div class="json-container">
    <div class="panels-container">
      <div class="left-panel">
        <div class="json-input-section">
          <div id="jsonInputs"></div>
        </div>
      </div>
      <div class="right-panel">
        <div class="json-input-section">
          <div id="jsonInputs2"></div>
        </div>
      </div>
    </div>

    <div style="text-align:center;">
      <button class="btn btn-primary" id="standaloneCompareBtn" onclick="standaloneCompare()">🔄 Compare JSONs</button>
      <div id="compareStatus" style="margin-top:10px;font-size:14px;color:#6c757d;"></div>
    </div>

    <div class="comparison-section" id="comparisonSection" style="display:none;">
      <div class="comparison-header">
        <h3 class="comparison-title">JSON Comparison</h3>
        <div class="comparison-buttons">
          <button class="btn btn-secondary" id="summaryToggleBtn" onclick="toggleSummary()">📊 Show Summary</button>
        </div>
      </div>
      <div class="comparison-grid" id="comparisonGrid"></div>
    </div>
  </div>

  <script>
    let jsonInputs = [];
    let jsonInputs2 = [];
    let summaryVisible = false;

    document.addEventListener('DOMContentLoaded', () => {
      addJsonInput(); addJsonInput2(); loadSampleData();
    });

    function loadSampleData() {
      const sampleJson1 = {
        "user": {
          "id": 1,
          "name": "John Doe",
          "email": "john@example.com",
          "address": { "street": "123 Main St", "city": "New York", "zipCode": "10001" },
          "hobbies": ["reading", "swimming", "coding"],
          "skills": [
            {"name": "JavaScript", "level": "expert"},
            {"name": "Python", "level": "intermediate"},
            {"name": "React", "level": "advanced"}
          ],
          "isActive": true,
          "lastLogin": "2024-01-15T10:30:00Z"
        },
        "metadata": { "version": "1.0", "created": "2024-01-01", "tags": ["user", "profile"] }
      };

      const sampleJson2 = {
        "user": {
          "id": 1,
          "name": "Jane Smith",
          "email": "jane@example.com",
          "address": { "street": "456 Oak Ave", "city": "Los Angeles", "zipCode": "90210" },
          "hobbies": ["reading", "swimming", "coding"],
          "skills": [
            {"name": "JavaScript", "level": "expert"},
            {"name": "Python", "level": "intermediate"},
            {"name": "Vue", "level": "advanced"}
          ],
          "isActive": true,
          "lastLogin": "2024-01-15T10:30:00Z"
        },
        "metadata": { "version": "1.0", "created": "2024-01-01", "tags": ["user", "profile"] },
        "preferences": { "theme": "dark", "notifications": true }
      };

      setTimeout(() => {
        const t1 = document.getElementById('jsonInput_0');
        const t2 = document.getElementById('jsonInput2_0');
        if (t1) t1.value = JSON.stringify(sampleJson1, null, 2);
        if (t2) t2.value = JSON.stringify(sampleJson2, null, 2);
      }, 120);
    }

    function addJsonInput() {
      const container = document.getElementById('jsonInputs');
      const inputId = `jsonInput_${jsonInputs.length}`;
      const groupId = `jsonGroup_${jsonInputs.length}`;

      const div = document.createElement('div');
      div.className = 'json-input-group';
      div.id = groupId;
      div.innerHTML = `
        <button class="remove-json-btn" onclick="removeJsonInput('${groupId}')" title="Remove JSON">×</button>
        <textarea class="json-textarea" id="${inputId}" placeholder="Paste your JSON here..."></textarea>
        <div class="json-actions">
          <button class="btn btn-primary" onclick="togglePreview('${inputId}')">👁️ Toggle Preview</button>
          <button class="btn btn-success" onclick="beautifyJson('${inputId}')">✨ Beautify</button>
          <button class="btn btn-secondary" onclick="clearJson('${inputId}')">🗑️ Clear</button>
        </div>
        <div class="json-preview" id="preview_${inputId}" style="display:none;">
          <div class="json-preview-header">
            <span class="json-preview-title">JSON Preview</span>
            <div class="json-preview-actions">
              <button class="mini-btn" onclick="expandAll('viewer_${inputId}')">Expand all</button>
              <button class="mini-btn" onclick="collapseAll('viewer_${inputId}')">Collapse all</button>
              <button class="mini-btn" onclick="copyToClipboard('${inputId}')">📋 Copy</button>
            </div>
          </div>
          <div class="json-viewer" id="viewer_${inputId}"></div>
        </div>
      `;
      container.appendChild(div);
      jsonInputs.push(inputId);
    }

    function addJsonInput2() {
      const container = document.getElementById('jsonInputs2');
      const inputId = `jsonInput2_${jsonInputs2.length}`;
      const groupId = `jsonGroup2_${jsonInputs2.length}`;

      const div = document.createElement('div');
      div.className = 'json-input-group';
      div.id = groupId;
      div.innerHTML = `
        <button class="remove-json-btn" onclick="removeJsonInput2('${groupId}')" title="Remove JSON">×</button>
        <textarea class="json-textarea" id="${inputId}" placeholder="Paste your JSON here..."></textarea>
        <div class="json-actions">
          <button class="btn btn-primary" onclick="togglePreview('${inputId}')">👁️ Toggle Preview</button>
          <button class="btn btn-success" onclick="beautifyJson('${inputId}')">✨ Beautify</button>
          <button class="btn btn-secondary" onclick="clearJson('${inputId}')">🗑️ Clear</button>
        </div>
        <div class="json-preview" id="preview_${inputId}" style="display:none;">
          <div class="json-preview-header">
            <span class="json-preview-title">JSON Preview</span>
            <div class="json-preview-actions">
              <button class="mini-btn" onclick="expandAll('viewer_${inputId}')">Expand all</button>
              <button class="mini-btn" onclick="collapseAll('viewer_${inputId}')">Collapse all</button>
              <button class="mini-btn" onclick="copyToClipboard('${inputId}')">📋 Copy</button>
            </div>
          </div>
          <div class="json-viewer" id="viewer_${inputId}"></div>
        </div>
      `;
      container.appendChild(div);
      jsonInputs2.push(inputId);
    }

    function removeJsonInput(id){ const el=document.getElementById(id); if(el){ el.remove(); updateComparisonSection(); } }
    function removeJsonInput2(id){ const el=document.getElementById(id); if(el){ el.remove(); updateComparisonSection(); } }

    function clearJson(id){
      const t = document.getElementById(id);
      const p = document.getElementById(`preview_${id}`);
      t.value=''; t.classList.remove('error'); p.style.display='none';
    }

    function beautifyJson(id){
      const t = document.getElementById(id); const v=t.value.trim();
      if(!v){ alert('Please enter some JSON data first.'); return; }
      try { t.value = JSON.stringify(JSON.parse(v), null, 2); t.classList.remove('error'); }
      catch { t.classList.add('error'); alert('Invalid JSON format. Cannot beautify invalid JSON.'); }
    }

    function togglePreview(id){
      const t=document.getElementById(id), v=t.value.trim();
      const p=document.getElementById(`preview_${id}`), viewer=document.getElementById(`viewer_${id}`);
      if(!v){ alert('Please enter some JSON data first.'); return; }
      if(p.style.display==='block'){ p.style.display='none'; return; }
      try{
        const parsed=JSON.parse(v);
        t.classList.remove('error');
        viewer.innerHTML = renderNode(parsed, false);
        p.style.display='block';
        updateComparisonSection();
      }catch{
        t.classList.add('error');
        alert('Invalid JSON format. Please check your input.');
        viewer.innerHTML = '<div style="color:#dc2626;padding:10px;background:#fee2e2;border-radius:4px;">Invalid JSON format. Please check your input and try again.</div>';
        p.style.display='block';
      }
    }

    /* =========================
       RENDERERS
       - Collapsed shows ONE inline token: “[ … n items ].” or “{ … n keys }.”
       - Commas remain on the same line (shown inline when collapsed)
       ========================= */

    function renderNode(obj, trailingComma) {
      if (obj === null) return `<span class="json-null">null</span>${trailingComma?`<span class="json-comma">,</span>`:''}`;
      if (typeof obj === 'string') return `<span class="json-string">"${obj}"</span>${trailingComma?`<span class="json-comma">,</span>`:''}`;
      if (typeof obj === 'number') return `<span class="json-number">${obj}</span>${trailingComma?`<span class="json-comma">,</span>`:''}`;
      if (typeof obj === 'boolean') return `<span class="json-boolean">${obj}</span>${trailingComma?`<span class="json-comma">,</span>`:''}`;

      if (Array.isArray(obj)) {
        const n = obj.length;
        if (n === 0) {
          return `<span class="json-wrapper"><div class="json-openline"><span class="json-brace">[ ]</span>${trailingComma?`<span class="json-comma">,</span>`:''}</div></span>`;
        }
        const items = obj.map((item, idx) => {
          const commaForItem = idx < n - 1;
          return `<div class="json-item">${renderNode(item, commaForItem)}</div>`;
        }).join('');
        return `
          <span class="json-wrapper">
            <div class="json-openline" data-type="array">
              <span class="json-toggle" onclick="toggleJsonItem(this)">▼</span>
              <span class="json-brace json-open-brace">[</span>
              <span class="json-inline-collapsed">[ … ${n} item${n!==1?'s':''} ].</span><span class="json-inline-comma">${trailingComma?',':''}</span>
            </div>
            <div class="json-children">${items}</div>
            <div class="json-closeline">
              <span class="json-closer">]</span>${trailingComma?`<span class="json-comma">,</span>`:''}
            </div>
          </span>
        `;
      }

      const keys = Object.keys(obj);
      const n = keys.length;
      if (n === 0) {
        return `<span class="json-wrapper"><div class="json-openline"><span class="json-brace">{ }</span>${trailingComma?`<span class="json-comma">,</span>`:''}</div></span>`;
        }

      const items = keys.map((k, i) => {
        const commaForItem = i < n - 1;
        const v = obj[k];
        return `<div class="json-item"><span class="json-key">"${k}"</span>: ${renderNode(v, commaForItem)}</div>`;
      }).join('');

      return `
        <span class="json-wrapper">
          <div class="json-openline" data-type="object">
            <span class="json-toggle" onclick="toggleJsonItem(this)">▼</span>
            <span class="json-brace json-open-brace">{</span>
            <span class="json-inline-collapsed">{ … ${n} key${n!==1?'s':''} }.</span><span class="json-inline-comma">${trailingComma?',':''}</span>
          </div>
          <div class="json-children">${items}</div>
          <div class="json-closeline">
            <span class="json-closer">}</span>${trailingComma?`<span class="json-comma">,</span>`:''}
          </div>
        </span>
      `;
    }

    /* =========================
       Comparison renderer with LIGHT-GREEN value highlight
       (only when the SAME KEY exists in both and the VALUE differs).
       We detect this at primitive leaves.
       ========================= */
    function renderNodeWithHighlight(obj, compareObj, trailingComma, path = '') {
      // primitives (leaf) — apply green highlight if both exist and differ
      const isPrimitive = (v) => v === null || typeof v === 'string' || typeof v === 'number' || typeof v === 'boolean';
      if (isPrimitive(obj)) {
        const bothExist = typeof compareObj !== 'undefined';
        const differs = bothExist && JSON.stringify(obj) !== JSON.stringify(compareObj);
        const content =
          obj === null ? 'null' :
          typeof obj === 'string' ? `"${obj}"` :
          String(obj);
        const wrapped = differs ? `<span class="diff-value-changed">${content}</span>` :
                      (obj === null ? `<span class="json-null">${content}</span>` :
                       typeof obj === 'string' ? `<span class="json-string">${content}</span>` :
                       typeof obj === 'number' ? `<span class="json-number">${content}</span>` :
                       `<span class="json-boolean">${content}</span>`);
        return `${wrapped}${trailingComma?`<span class="json-comma">,</span>`:''}`;
      }

      // arrays
      if (Array.isArray(obj)) {
        const n = obj.length;
        if (n === 0) {
          return `<span class="json-wrapper"><div class="json-openline"><span class="json-brace">[ ]</span>${trailingComma?`<span class="json-comma">,</span>`:''}</div></span>`;
        }
        const items = obj.map((item, idx) => {
          const cmp = Array.isArray(compareObj) ? compareObj[idx] : undefined;
          const commaForItem = idx < n - 1;
          return `<div class="json-item">${renderNodeWithHighlight(item, cmp, commaForItem, path + '[' + idx + ']')}</div>`;
        }).join('');
        return `
          <span class="json-wrapper">
            <div class="json-openline" data-type="array">
              <span class="json-toggle" onclick="toggleJsonItem(this)">▼</span>
              <span class="json-brace json-open-brace">[</span>
              <span class="json-inline-collapsed">[ … ${n} item${n!==1?'s':''} ].</span><span class="json-inline-comma">${trailingComma?',':''}</span>
            </div>
            <div class="json-children">${items}</div>
            <div class="json-closeline">
              <span class="json-closer">]</span>${trailingComma?`<span class="json-comma">,</span>`:''}
            </div>
          </span>
        `;
      }

      // objects
      const keys = Object.keys(obj);
      const n = keys.length;
      if (n === 0) {
        return `<span class="json-wrapper"><div class="json-openline"><span class="json-brace">{ }</span>${trailingComma?`<span class="json-comma">,</span>`:''}</div></span>`;
      }

      const items = keys.map((key, i) => {
        const v = obj[key];
        const cmpPresent = compareObj && Object.prototype.hasOwnProperty.call(compareObj, key);
        const cmp = cmpPresent ? compareObj[key] : undefined;

        const keyClass = cmpPresent ? '' : 'diff-key-missing'; // NOT green; indicates missing on the other side

        const commaForItem = i < n - 1;
        return `<div class="json-item"><span class="json-key ${keyClass}">"${key}"</span>: ${renderNodeWithHighlight(v, cmp, commaForItem, path ? `${path}.${key}` : key)}</div>`;
      }).join('');

      return `
        <span class="json-wrapper">
          <div class="json-openline" data-type="object">
            <span class="json-toggle" onclick="toggleJsonItem(this)">▼</span>
            <span class="json-brace json-open-brace">{</span>
            <span class="json-inline-collapsed">{ … ${n} key${n!==1?'s':''} }.</span><span class="json-inline-comma">${trailingComma?',':''}</span>
          </div>
          <div class="json-children">${items}</div>
          <div class="json-closeline">
            <span class="json-closer">}</span>${trailingComma?`<span class="json-comma">,</span>`:''}
          </div>
        </span>
      `;
    }

    function renderJsonWithHighlight(a, b) { return renderNodeWithHighlight(a, b, false, ''); }

    /* ---------- Toggle / Expand / Collapse ---------- */
    function toggleJsonItem(toggle) {
      const wrapper = toggle.closest('.json-wrapper');
      if (!wrapper) return;

      const children   = wrapper.querySelector(':scope > .json-children');
      const closeline  = wrapper.querySelector(':scope > .json-closeline');
      const openline   = wrapper.querySelector(':scope > .json-openline');
      const openBrace  = openline?.querySelector('.json-open-brace');
      const inlineTok  = openline?.querySelector('.json-inline-collapsed');
      const inlineComma= openline?.querySelector('.json-inline-comma');

      const isExpanded = (children?.style.display || window.getComputedStyle(children).display) !== 'none';

      if (isExpanded) {
        if (children) children.style.display = 'none';
        if (closeline) closeline.style.display = 'none';
        if (openBrace) openBrace.style.display = 'none';
        if (inlineTok) inlineTok.style.display = 'inline';
        if (inlineComma) inlineComma.style.display = 'inline';
        toggle.textContent = '▶';
      } else {
        if (children) children.style.display = 'block';
        if (closeline) closeline.style.display = 'flex';
        if (openBrace) openBrace.style.display = 'inline';
        if (inlineTok) inlineTok.style.display = 'none';
        if (inlineComma) inlineComma.style.display = 'none';
        toggle.textContent = '▼';
      }
    }

    function expandAll(viewerId) {
      const root = document.getElementById(viewerId);
      if (!root) return;
      root.querySelectorAll('.json-wrapper').forEach(w => {
        const children = w.querySelector(':scope > .json-children');
        const closeline= w.querySelector(':scope > .json-closeline');
        const openBrace= w.querySelector(':scope > .json-openline .json-open-brace');
        const inlineTok= w.querySelector(':scope > .json-openline .json-inline-collapsed');
        const inlineComma= w.querySelector(':scope > .json-openline .json-inline-comma');
        const toggle = w.querySelector(':scope > .json-openline > .json-toggle');

        if (children) children.style.display = 'block';
        if (closeline) closeline.style.display = 'flex';
        if (openBrace) openBrace.style.display = 'inline';
        if (inlineTok) inlineTok.style.display = 'none';
        if (inlineComma) inlineComma.style.display = 'none';
        if (toggle) toggle.textContent = '▼';
      });
    }

    function collapseAll(viewerId) {
      const root = document.getElementById(viewerId);
      if (!root) return;
      root.querySelectorAll('.json-wrapper').forEach(w => {
        const children = w.querySelector(':scope > .json-children');
        const closeline= w.querySelector(':scope > .json-closeline');
        const openBrace= w.querySelector(':scope > .json-openline .json-open-brace');
        const inlineTok= w.querySelector(':scope > .json-openline .json-inline-collapsed');
        const inlineComma= w.querySelector(':scope > .json-openline .json-inline-comma');
        const toggle = w.querySelector(':scope > .json-openline > .json-toggle');

        if (children) children.style.display = 'none';
        if (closeline) closeline.style.display = 'none';
        if (openBrace) openBrace.style.display = 'none';
        if (inlineTok) inlineTok.style.display = 'inline';
        if (inlineComma) inlineComma.style.display = 'inline';
        if (toggle) toggle.textContent = '▶';
      });
    }

    /* ---------- Comparison + Diff table (unchanged) ---------- */
    function updateComparisonSection() {
      const section = document.getElementById('comparisonSection');
      const valid1 = jsonInputs.filter(id => {
        const t=document.getElementById(id);
        return t && t.value.trim() && !t.classList.contains('error');
      });
      const valid2 = jsonInputs2.filter(id => {
        const t=document.getElementById(id);
        return t && t.value.trim() && !t.classList.contains('error');
      });
      section.style.display = (valid1.length && valid2.length) ? 'block' : 'none';
    }

    function standaloneCompare() {
      const status = document.getElementById('compareStatus');
      const valid1 = jsonInputs.filter(id => {
        const t=document.getElementById(id);
        return t.value.trim() && !t.classList.contains('error');
      });
      const valid2 = jsonInputs2.filter(id => {
        const t=document.getElementById(id);
        return t.value.trim() && !t.classList.contains('error');
      });
      if(!valid1.length){ status.textContent='❌ Please add valid JSON to the left panel'; status.style.color='#dc2626'; return; }
      if(!valid2.length){ status.textContent='❌ Please add valid JSON to the right panel'; status.style.color='#dc2626'; return; }

      try { JSON.parse(document.getElementById(valid1[0]).value); }
      catch { status.textContent='❌ Invalid JSON in left panel'; status.style.color='#dc2626'; return; }
      try { JSON.parse(document.getElementById(valid2[0]).value); }
      catch { status.textContent='❌ Invalid JSON in right panel'; status.style.color='#dc2626'; return; }

      const section = document.getElementById('comparisonSection');
      section.style.display='block'; section.scrollIntoView({behavior:'smooth'});
      compareJsons();
    }

    function compareJsons() {
      const valid1 = jsonInputs.filter(id => {
        const t=document.getElementById(id);
        return t.value.trim() && !t.classList.contains('error');
      });
      const valid2 = jsonInputs2.filter(id => {
        const t=document.getElementById(id);
        return t.value.trim() && !t.classList.contains('error');
      });
      if(!valid1.length || !valid2.length) return;

      const grid = document.getElementById('comparisonGrid');
      const existingSummary = document.getElementById('summaryItem');
      if(!existingSummary) grid.innerHTML='';

      const json1 = JSON.parse(document.getElementById(valid1[0]).value);
      const json2 = JSON.parse(document.getElementById(valid2[0]).value);

      const item = document.createElement('div');
      item.className='comparison-item';
      item.innerHTML = `
        <div class="comparison-item-header">Left Panel vs Right Panel</div>
        <div class="comparison-content">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <div>
              <h4>Left Panel JSON</h4>
              <div class="json-viewer">${renderJsonWithHighlight(json1, json2)}</div>
            </div>
            <div>
              <h4>Right Panel JSON</h4>
              <div class="json-viewer">${renderJsonWithHighlight(json2, json1)}</div>
            </div>
          </div>
        </div>
      `;
      grid.appendChild(item);
    }

    function toggleSummary() {
      const btn = document.getElementById('summaryToggleBtn');
      const grid = document.getElementById('comparisonGrid');
      summaryVisible = !summaryVisible;

      const valid1 = jsonInputs.filter(id => {
        const t=document.getElementById(id);
        return t.value.trim() && !t.classList.contains('error');
      });
      const valid2 = jsonInputs2.filter(id => {
        const t=document.getElementById(id);
        return t.value.trim() && !t.classList.contains('error');
      });
      if(!valid1.length || !valid2.length){ alert('Please provide at least 1 valid JSON input on each side to compare.'); summaryVisible=false; return; }

      if (summaryVisible) {
        btn.textContent = '📊 Show Comparison Panel';
        const existing = grid.querySelector('.comparison-item');
        if (existing) existing.remove();

        const json1 = JSON.parse(document.getElementById(valid1[0]).value);
        const json2 = JSON.parse(document.getElementById(valid2[0]).value);

        const summary = document.createElement('div');
        summary.className='comparison-item';
        summary.id='summaryItem';
        summary.innerHTML = `
          <div class="comparison-item-header">JSON Comparison Summary</div>
          <div class="comparison-content">${renderComparisonAsTable(json1, json2)}</div>
        `;
        grid.appendChild(summary);
      } else {
        btn.textContent = '📊 Show Summary';
        const summary = document.getElementById('summaryItem');
        if (summary) summary.remove();
        compareJsons();
      }
    }

    function renderComparisonAsTable(obj1, obj2, path = '') {
      const diffs = findDifferences(obj1, obj2, path);
      if (!diffs.length) return '<div style="color:#16a34a;font-weight:bold;padding:20px;text-align:center;background:#dcfce7;border-radius:6px;">✓ No differences found - JSONs are identical</div>';

      let out = '<table class="summary-table"><thead><tr><th>Path</th><th>Type</th><th>Old Value / Removed</th><th>New Value / Added</th></tr></thead><tbody>';
      diffs.forEach(d => {
        out += '<tr>';
        out += `<td>${d.path}</td>`;
        if (d.type === 'added') {
          out += `<td><span class="diff-type diff-type-added">${d.type}</span></td><td>-</td><td><span class="diff-value-added">${JSON.stringify(d.value)}</span></td>`;
        } else if (d.type === 'removed') {
          out += `<td><span class="diff-type diff-type-removed">${d.type}</span></td><td><span class="diff-value-removed">${JSON.stringify(d.value)}</span></td><td>-</td>`;
        } else {
          out += `<td><span class="diff-type diff-type-changed">${d.type}</span></td><td><span class="diff-value-old">${JSON.stringify(d.oldValue)}</span></td><td><span class="diff-value-new">${JSON.stringify(d.newValue)}</span></td>`;
        }
        out += '</tr>';
      });
      out += '</tbody></table>';
      out += `<div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:6px;color:#92400e;"><strong>Total differences:</strong> ${diffs.length}</div>`;
      return out;
    }

    function findDifferences(obj1, obj2, path = '') {
      const differences = [];

      if (obj1 === null || obj1 === undefined) {
        if (obj2 !== null && obj2 !== undefined) differences.push({ path: path || 'root', type: 'added', value: obj2 });
        return differences;
      }
      if (obj2 === null || obj2 === undefined) {
        differences.push({ path: path || 'root', type: 'removed', value: obj1 });
        return differences;
      }

      if (Array.isArray(obj1) && Array.isArray(obj2)) {
        const maxLen = Math.max(obj1.length, obj2.length);
        for (let i=0;i<maxLen;i++){
          const cur = path ? `${path}[${i}]` : `[${i}]`;
          const v1 = obj1[i], v2 = obj2[i];
          if (i >= obj1.length && i < obj2.length) differences.push({ path: cur, type: 'added', value: v2 });
          else if (i < obj1.length && i >= obj2.length) differences.push({ path: cur, type: 'removed', value: v1 });
          else if (v1 !== undefined && v2 !== undefined){
            if (typeof v1 === 'object' && typeof v2 === 'object' && v1 !== null && v2 !== null) {
              differences.push(...findDifferences(v1, v2, cur));
            } else if (v1 !== v2) {
              differences.push({ path: cur, type: 'changed', oldValue: v1, newValue: v2 });
            }
          }
        }
        return differences;
      }

      if (Array.isArray(obj1) !== Array.isArray(obj2)) {
        differences.push({ path: path || 'root', type: 'changed', oldValue: obj1, newValue: obj2 });
        return differences;
      }

      if (typeof obj1 === 'object' && typeof obj2 === 'object' && obj1 !== null && obj2 !== null) {
        const keys = new Set([...Object.keys(obj1), ...Object.keys(obj2)]);
        for (const k of keys) {
          const cur = path ? `${path}.${k}` : k;
          const v1 = Object.prototype.hasOwnProperty.call(obj1, k) ? obj1[k] : undefined;
          const v2 = Object.prototype.hasOwnProperty.call(obj2, k) ? obj2[k] : undefined;

          if (v1 === undefined && v2 !== undefined) differences.push({ path: cur, type: 'added', value: v2 });
          else if (v1 !== undefined && v2 === undefined) differences.push({ path: cur, type: 'removed', value: v1 });
          else if (typeof v1 === 'object' && typeof v2 === 'object' && v1 !== null && v2 !== null) {
            differences.push(...findDifferences(v1, v2, cur));
          } else if (v1 !== v2) {
            differences.push({ path: cur, type: 'changed', oldValue: v1, newValue: v2 });
          }
        }
      } else if (obj1 !== obj2) {
        differences.push({ path: path || 'root', type: 'changed', oldValue: obj1, newValue: obj2 });
      }

      return differences;
    }

    function copyToClipboard(inputId) {
      const t = document.getElementById(inputId);
      const v = t.value.trim();
      if(!v){ alert('No JSON data to copy.'); return; }
      navigator.clipboard.writeText(v).then(() => {
        const btn = event.target;
        const original = btn.textContent;
        btn.textContent = '✓ Copied!'; btn.style.background = '#10b981';
        setTimeout(()=>{ btn.textContent = original; btn.style.background = ''; }, 1500);
      }).catch(()=> alert('Failed to copy to clipboard.'));
    }
  </script>
</body>
</html>
